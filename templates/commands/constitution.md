---
description: 智能初始化或“修宪”。支持从零创建项目宪法，或在保留已有规则的基础上进行增量更新。
handoffs:
  - label: 开始定义需求
    agent: myspec.define
    prompt: 宪法已确立，开始定义新功能...

---

## User Input

```
$ARGUMENTS
```

在继续操作之前，你必须考虑用户的输入（如果输入不为空）。

## Outline

你是本项目的**首席架构师**（Chief Architect）。你的任务是维护项目的宪法（`context/constitution.md`）。这包括**创建新宪法**或**对现有宪法进行增量修订**。它不仅仅是一份文档，它是项目的法律。你的输出必须**详尽、专业、具有约束力**，类似于企业级架构白皮书，而不是简单的 Readme。

你将会创建或更新位于 `/context/constitution.md` 的项目宪法文档。此文档的**模板**在`templates/constitution-template.md`，内含用方括号标出的占位符（例如 `SECTION_1_TITLE`）。你需要完成的任务是：(a) 根据用户提供的输入推导出具体的值，(b) 精确地填充模板

请严格遵循以下执行逻辑：

### 第一阶段：环境扫描与模式判定 (Scan & Decide)

1. **检查文件状态**：
   - 检查 `context/constitution.md` 是否存在。
2. **判定运行模式**：
   - **[新建模式]**：如果文件**不存在** -> 进入 **第二阶段 A**。
   - **[更新模式]**：如果文件**已存在** -> 进入 **第二阶段 B**。

### 第二阶段 A：新建模式 (Create from Scratch)

*仅当文件不存在时执行此流程。*

1. **意图解析与脑补 (Deep Analysis & Inference)**：
   - 分析 `$ARGUMENTS`。
   - **关键指令**：如果用户输入很简短，你必须基于**行业最佳实践**自动推导缺失的内容。
2. **加载模板**：读取 `templates/constitution-template.md`，识别所有由 `[]` 包裹的占位符。**重要提示**：用户输入中要求的原则数量可能与模板中预设的数量不同。你需要尊重用户指定的数量，并依此调整文档的结构。
3. **核心原则填充 (Core Principles Generation)**：
   - **目标**：填充核心原则中的章节，根据用户输入决定原则数量，模板仅作为格式参考。
   - **写作标准**：
     - **标题**：简短有力，使用动宾结构或名词短语（如 "API-First Design"）。
     - **描述**：必须是 **Non-negotiable (不可妥协)**：使用 "Must", "Strictly enforced" 等强语气。
4. **通用章节填充 (General Sections Generation)**：
   - **目标**：根据用户输入填充后续通用章节，根据用户输入决定章节数量，模板仅作为格式参考。
   - **写作标准**：保持深度和可测试性以及必要的理由说明。
5. **内容完善**：
   - 保留原有的标题层级。注释内容在替换后若无必要可移除。其他非注释内容需要保留（模板中的固定文本）。
   - 确保每个“原则”章节和通用章节都包含：简洁的名称、阐述核心规则的段落（或列表），以及必要的理由说明。
   - 模板中的”核心开发工作流“和”AI 协作公约 (Agent Protocols)“两个章节始终放在宪法的最后，章节标题不需要序号
   - 将生效日期和最后修订日期都设置为当前时间

### 第二阶段 B：更新模式 (Incremental Update)

*仅当文件已存在时执行此流程。*

1. **读取现有宪法**：

   - 完整读取 `context/constitution.md` 的内容。
   - **理解上下文**：分析现有的宪法的结构和内容。

2. **分析修订意图**：

   - 仔细阅读用户的 `$ARGUMENTS`，确定“修宪”的具体目的。例如：
     - *追加规则*
     - *修改要求*
     - *补充章节*

3. **执行智能修订 (Smart Patching)**：

   - **原则：非破坏性更新**。除非用户明确要求“删除”或“替换”，否则一律视为“追加”或“细化”。

   - **操作策略**：

     - **修改原则**: 定位到 `## Core Principles` 区域。

       - 如果是**新增**原则：在现有原则列表末尾追加。
       - 如果是**修改**原则：精准更新描述，保留原有的 Rationale 格式。

       **修改通用章节**: 定位到对应标题。

       - **追加 (Append)**: 保持格式一致。
       - **细化 (Refine)**: 替换过时的版本或规则。

   - **内容完善：**

     - 确保修改后的宪法中每个“原则”章节和通用章节都仍然包含：简洁的名称、阐述核心规则的段落（或列表），以及必要的理由说明。
     - 将最后修订日期设置为当前日期

### 第三阶段：版本更新与治理注入 (Persist & Enforce)

1. **版本号轮转**：

   - 如果是更新模式，找到文档底部的 `> **版本号**: x.x.x`，修改版本号（规则如下），并更新 `最后修订日期`为当前日期。
   - 宪法的版本号必须遵循语义化版本规范进行递增：
     - **主版本号 (MAJOR)**：进行不向后兼容的重大变更，例如移除或重新定义原则。
     - **次版本号 (MINOR)**：新增原则或章节，或对指导内容进行实质性扩充。
     - **修订号 (PATCH)**：进行澄清、措辞调整、修正笔误等非破坏性更新。

   * 若版本升级类型难以确定，请在最终确定前提出你的判断理由。

2. **注入 CLAUDE.md**：

   - 检查根目录是否有 `CLAUDE.md`，如果没有则由你运行`/init`命令来创建。

   - 确保在其文件末尾包含以下治理指令（如果已有则不重复添加）：

     ```markdown
     ## 🛡️ 项目治理指令 (Governance)
     **最高准则**: 本项目所有代码生成与规划必须严格遵循: `context/constitution.md`
     ```

### 第四阶段：写入文档与报告输出

1. **生成同步影响报告**（在创建或更新宪法后，都要以 HTML 注释的形式将下面的几个内容添加在宪法文件的顶部，如果是更新则在原先注释位置的上方添加当前新注释）：
   * 版本变更记录：旧版本 → 新版本（如果是创建则新旧版本号相同）
   * 核心原则中已修改（新增、修改或删除）的原则列表（若重命名，请注明：旧标题 → 新标题）
   * 新增、修改或删除的通用章节列表
2. **最终输出前的验证**：
   * 确保没有方括号占位符遗留。
   * 确保文件中的版本号与报告一致。
   * 日期使用 ISO 格式 (YYYY-MM-DD)。
   * 语言描述应该明确、可验证，避免使用模糊不清的语言。
   * **格式与风格要求**：
     - 严格保持模板中的 Markdown 标题层级。
     - 每个章节的标题应该尽量简洁，但章节的具体内容应该尽可能的详细。
     - 为使行文清晰易读，建议行长控制在 100 字符以内，但避免生硬的断行。
     - 章节间用一个空行分隔。
     - 避免行尾空格。
   * 确保宪法文件顶部有同步影响报告。
3. **写回文件**：将最终确定的宪法内容写入 `/context/constitution.md`；将`CLAUDE.md`的内容也写回对应文档。
4. **向用户输出最终摘要**，内容包括：
   - 新版本号及版本升级的理由。
   - 建议的提交信息（例如：`docs: 更新章程至 vX.Y.Z（新增原则及治理更新）`）。



**注意事项**：

- 即使用户只提供了部分更新（例如仅修订一条原则），也仍需完成上述的完整流程。
- **注意，严格按照阶段从一到四的阶段顺序执行，在第四阶段完成所有验证之后才将内容正式写入到文件中！**
- 只在最后完成后向用户输出最终摘要，中途不要在终端中输出过多内容。

