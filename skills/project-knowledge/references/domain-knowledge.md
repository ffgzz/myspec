# 企业资产管理系统 - 核心领域知识

## 业务背景

企业资产管理系统用于追踪 IT 设备（笔记本、显示器、服务器、网络设备等）的完整生命周期，解决设备追踪混乱、资产丢失、重复采购、责任不清等问题。核心目标是实现"从采购入库到报废处置"的全流程可追溯性，确保每一件设备都有清晰的状态和责任人。

**典型痛点：**
- IT 管理员不知道某台笔记本分配给了谁
- 员工离职时设备未归还，造成资产流失
- 维修中的设备被误分配，导致业务受影响
- 无法快速统计各部门的设备使用情况
- 审计时无法提供完整的资产历史记录

---

## 核心概念

### 1. 资产（Asset）
组织拥有并需要追踪的实物设备。每个资产必须具备：

**关键属性：**
- **序列号（Serial Number）**：全局唯一标识符
  - 来源：设备制造商提供（如 Dell SN、Apple Serial Number）
  - 特性：创建后永不更改，即使资产报废也保留记录
  - 格式：通常为 8-20 位字母数字组合
  - 作用：防止重复录入、支持保修查询、责任追溯
  
- **资产标签（Asset Tag）**：组织内部编号
  - 格式示例：IT-2024-000123（部门-年份-流水号）
  - 通常以贴纸形式贴在设备上，便于快速识别
  - 与序列号互补，序列号是厂商标识，资产标签是内部标识
  
- **资产类型**：笔记本电脑、台式机、显示器、服务器、网络设备、外设等
  - 影响分配策略（如：开发人员优先分配高性能笔记本）
  - 影响维护周期（如：服务器需更频繁检查）
  
- **状态**：反映资产当前所处的生命周期阶段（详见下节）

- **采购信息**：
  - 采购日期：用于计算使用年限
  - 采购价格：用于折旧计算、资产价值统计
  - 供应商：便于批量采购、维修联系
  - 保修期：影响维修决策（保内送修 vs 自行维修）

**核心原则：**
- 每个资产都有且仅有一个序列号
- 资产的历史记录永久保留，不可删除
- 系统是资产状态的唯一权威来源

### 2. 员工（Employee）
资产的使用者和临时保管人（注意：员工不是资产的所有者，资产所有权属于公司）。

**关键信息：**
- **员工ID**：唯一标识符，通常与 HR 系统同步（如：EMP001234）
- **姓名**：用于搜索和显示，需支持中英文
- **部门**：IT部、研发部、销售部等
  - 用于资产分配策略（不同部门不同配置标准）
  - 用于统计报表（各部门资产使用情况）
- **在职状态**：在职/离职
  - 离职员工必须归还所有资产才能完成离职流程
  - 离职后的员工记录保留（用于历史追溯）

**业务规则：**
- 只有"在职"状态的员工才能被分配新资产
- 员工变更部门时，可能需要重新评估资产分配
- 员工离职时，系统必须自动检查是否有未归还资产

### 3. 资产分配（Asset Assignment）
记录"谁在什么时候领用了什么资产"的关联关系。

**核心属性：**
- **资产ID + 员工ID**：关联关系
- **分配时间戳**：精确到秒，不可更改（审计用）
- **归还时间戳**：资产归还时记录，为空表示仍在使用
- **分配原因**：新员工入职、设备升级、临时借用、故障更换等
- **操作人**：执行分配操作的 IT 管理员（责任追溯）

**关系特性：**
- **一对多**：一个员工可以同时持有多个资产
  - 示例：张三持有 1 台笔记本 + 2 台显示器 + 1 套键鼠
- **时间性**：分配记录有开始时间和结束时间（归还时）
- **历史性**：所有历史分配记录永久保留，支持查询"这台设备被谁用过"

---

## 资产生命周期状态

资产从入库到报废，经历不同的状态。状态转换必须遵循业务逻辑。

### 四种核心状态
```
[库存中] ←→ [已分配] → [维修中] → [已报废]
```

#### 1. 库存中（Available）
**定义：** 资产已入库，完成检验，处于可用状态，等待分配。

**特征：**
- 物理位置：IT 资产仓库或设备间
- 责任人：IT 部门集体负责
- 可执行操作：分配、送修、报废、信息更新

**典型场景：**
- 新采购设备完成验收后的初始状态
- 员工归还设备后，经检查无问题恢复的状态
- 维修完成后，经质检合格恢复的状态

#### 2. 已分配（Assigned）
**定义：** 资产已分配给特定员工，正在被使用。

**特征：**
- 物理位置：员工工位或员工手中
- 责任人：被分配的员工（丢失/损坏由员工承担责任）
- 关联信息：员工ID、分配时间、预期归还时间（如有）

**可执行操作：**
- 归还（员工主动归还或离职强制归还）
- 报修（使用中发现故障）
- 查看使用详情

**典型场景：**
- 新员工入职，领用笔记本电脑和显示器
- 现有员工设备升级，旧设备归还，新设备分配
- 临时借用（如：参加会议需要投影仪）

#### 3. 维修中（Under Maintenance）
**定义：** 资产因故障、损坏需要维修，暂时不可用。

**特征：**
- 物理位置：内部维修间或外部维修中心
- 责任人：IT 维修人员或外部供应商
- 附加信息：故障描述、维修单号、预计完成时间

**可执行操作：**
- 更新维修进度
- 维修完成 → 转回"库存中"或"已分配"（如归还原员工）
- 维修失败/成本过高 → 转入"已报废"

**典型场景：**
- 员工使用中发现故障报修
- 入库检查时发现硬件问题
- 定期保养维护

**重要规则：**
- 维修中的资产严禁分配给其他员工
- 必须记录维修原因、维修人、维修结果

#### 4. 已报废（Retired）
**定义：** 资产已达生命周期终点，不再使用，终态不可逆。

**特征：**
- 物理状态：已处置、回收或销毁
- 系统状态：只读，不可修改状态
- 记录保留：永久保留用于审计和资产统计

**报废原因：**
- 使用年限到期（如：笔记本使用 5 年）
- 严重损坏无法维修或维修成本过高
- 技术过时，无法满足业务需求
- 丢失或被盗（记录责任人）

**处置流程：**
- 数据安全擦除（防止信息泄露）
- 资产价值评估（是否可转售或回收）
- 报废审批和记录
- 物理销毁或转售给认证回收商

**重要规则：**
- 已报废的资产不能恢复到任何其他状态
- 报废决策需要管理员权限
- 报废记录必须包含：报废原因、报废人、报废时间

---

## 状态转换规则（关键业务逻辑）

### 允许的转换路径

| 当前状态 | 目标状态 | 触发条件                | 业务场景                 |
| -------- | -------- | ----------------------- | ------------------------ |
| 库存中   | 已分配   | 员工领用 + 状态验证通过 | 新员工入职、设备更换     |
| 已分配   | 库存中   | 员工归还 + 验收通过     | 员工离职、设备升级       |
| 库存中   | 维修中   | 发现故障                | 入库检查发现问题         |
| 已分配   | 维修中   | 使用中报修              | 员工使用时设备故障       |
| 维修中   | 库存中   | 维修完成 + 质检通过     | 故障修复，恢复可用       |
| 维修中   | 已分配   | 维修完成 + 归还原员工   | 维修后继续使用           |
| 任何状态 | 已报废   | 管理员审批              | 无法修复、超期使用、丢失 |

### 禁止的转换（必须拦截）
```
❌ 维修中 → 已分配（未经验收）
   原因：维修完成必须先经过质检，确认正常后才能重新分配

❌ 已报废 → 任何其他状态
   原因：报废是终态，不可逆

❌ 已分配 → 已分配（给不同员工）
   原因：必须先归还到"库存中"，再分配给新员工

❌ 维修中 → 已报废（未经评估）
   原因：需要评估维修成本 vs 资产价值，决策是否报废
```

### 状态转换的验证逻辑

**在执行分配操作时：**
```python
# 核心验证逻辑（伪代码）
def can_assign_asset(asset, employee):
    # 验证1：资产必须存在
    if not asset:
        return False, "资产不存在"
    
    # 验证2：资产状态必须为"库存中"
    if asset.status != "库存中":
        if asset.status == "已分配":
            return False, f"资产已分配给{asset.current_employee}，请先归还"
        elif asset.status == "维修中":
            return False, "资产正在维修，预计{asset.repair_end_date}完成"
        elif asset.status == "已报废":
            return False, "资产已报废，无法分配"
    
    # 验证3：员工必须在职
    if not employee or employee.status != "在职":
        return False, "员工不存在或已离职"
    
    # 验证4：检查员工是否超过持有限制（业务策略）
    current_count = count_employee_assets(employee.id, asset.type)
    if current_count >= MAX_LIMIT:
        return False, f"员工已持有{current_count}个{asset.type}，超过限制"
    
    return True, "验证通过"
```

---

## 关键业务规则

### 规则 1：状态前置验证（强制）
**内容：** 只有"库存中"的资产才能被分配，其他状态一律拒绝。

**实现层级：**
- 应用层：分配前检查状态
- 数据库层：使用触发器或存储过程二次验证
- API层：返回明确的错误码和错误消息

**错误提示要求：**
- 不仅要拒绝，还要明确告知原因和建议操作
- 示例："资产 IT-2024-001 正在维修中，预计 2024-12-10 完成。如需更换，请选择其他可用设备。"

### 规则 2：序列号全局唯一（强制）
**内容：** 每个资产的序列号必须全局唯一，防止重复录入。

**实现方式：**
- 数据库唯一约束：`UNIQUE INDEX ON serial_number`
- 应用层验证：入库前查询是否已存在
- 用户界面：实时提示"序列号已存在"

**边缘处理：**
- 如果扫描到重复序列号，提示"该设备已录入，资产标签：XXX，当前状态：XXX"
- 允许查看已存在资产的详细信息，避免误判

### 规则 3：历史记录永久保留（强制）
**内容：** 所有资产分配/归还操作必须记录，永久保留，不允许删除或修改。

**审计要求：**
- 记录内容：操作时间、操作人、操作类型、资产ID、员工ID、操作结果
- 记录不可篡改：使用 `append-only` 模式或区块链思想
- 支持查询："这台设备过去 3 年被谁用过？"

**实现建议：**
- 使用独立的 `audit_log` 表
- 记录 IP 地址、User-Agent 等元数据
- 定期归档历史数据（如：3 年前的数据迁移到冷存储）

### 规则 4：员工离职强制归还（强制）
**内容：** 员工离职前必须归还所有资产，否则阻止离职流程。

**实现流程：**
1. HR 系统发起离职申请
2. 自动查询该员工持有的所有资产
3. 如有未归还资产，发送通知给：
   - 员工本人（邮件 + 系统通知）
   - 员工直属经理
   - IT 部门管理员
4. 所有资产归还后，系统自动解除阻止
5. 完成离职流程

**例外处理：**
- 资产丢失：填写资产丢失报告，说明原因，由管理员审批后可继续离职
- 资产在维修：等待维修完成后归还，或由 IT 部门接管维修责任

### 规则 5：并发分配保护（强制）
**内容：** 防止同一资产被多个管理员同时分配给不同员工。

**技术实现：**
- 乐观锁：资产表增加 `version` 字段，更新时检查版本号
- 悲观锁：使用 `SELECT ... FOR UPDATE` 锁定资产行
- 分布式锁：使用 Redis 实现分布式环境下的锁

**用户体验：**
- 如果冲突，后者应收到友好提示："该资产刚刚已被分配给XXX，请刷新列表选择其他设备。"

### 规则 6：数据完整性约束
**数据库层约束：**
- `serial_number`: NOT NULL, UNIQUE
- `status`: NOT NULL, ENUM('库存中', '已分配', '维修中', '已报废')
- `purchase_price`: CHECK (purchase_price > 0 AND purchase_price <= 1000000)
- `assignment.return_date`: CHECK (return_date IS NULL OR return_date >= assignment_date)

---

## 性能要求

### 明确指标
在 **5万条资产数据** 规模下，查询响应时间必须 < 200ms：

1. **按员工姓名搜索**：查询某员工当前持有的所有资产
2. **按状态筛选**：查询所有"维修中"或"库存中"的资产
3. **序列号精确查询**：根据序列号查找唯一资产
4. **模糊搜索**：按型号、资产标签部分匹配搜索

### 实现建议
**索引策略：**
```sql
-- 单列索引
CREATE INDEX idx_asset_status ON assets(status);
CREATE INDEX idx_asset_serial ON assets(serial_number);
CREATE INDEX idx_employee_name ON employees(name);

-- 复合索引（用于常见组合查询）
CREATE INDEX idx_asset_status_type ON assets(status, asset_type);
CREATE INDEX idx_assignment_active ON assignments(employee_id, return_date) 
  WHERE return_date IS NULL;  -- 仅索引当前分配
```

**查询优化：**
- 使用分页：每页 20-50 条记录
- 避免 `SELECT *`：只查询需要的字段
- 使用覆盖索引：减少回表查询

**缓存策略：**
- 缓存资产类型、部门等枚举值（有效期 1 小时）
- 缓存热门查询结果（如："所有库存中的笔记本"）
- 使用 Redis 缓存，TTL 设置为 5-10 分钟

---

## 常见边缘案例

### 1. 并发冲突
**场景：** 两个管理员同时尝试将同一台笔记本分配给不同员工。

**处理策略：**
- 使用乐观锁或行锁确保只有一个操作成功
- 失败的一方收到明确提示："资产已被XXX分配给XXX，请选择其他设备。"

### 2. 维修超期
**场景：** 资产送修后超过 30 天未归还，可能存在问题。

**处理策略：**
- 系统自动发送提醒给 IT 管理员
- 在资产详情页显示警告："维修已超期 X 天"
- 提供"催促维修商"或"标记为丢失"的操作选项

### 3. 资产丢失
**场景：** 员工报告资产丢失（被盗、遗失等）。

**处理策略：**
- 创建"资产丢失报告"，记录：丢失时间、地点、经过
- 标记资产状态为"已报废"，原因："丢失"
- 记录责任人（该员工）
- 根据公司政策决定是否需要赔偿

### 4. 批量分配
**场景：** 新员工入职，需要同时分配笔记本、显示器、鼠标键盘。

**处理策略：**
- 支持批量选择多个资产
- 使用数据库事务确保全部成功或全部失败
- 如果部分资产不可用，提示具体是哪些，并允许重新选择

### 5. 跨部门调动
**场景：** 员工从销售部调到研发部，资产配置需求变化。

**处理策略：**
- 系统提示：该员工已调岗，建议重新评估资产配置
- IT 管理员可选择：保持现有资产 / 更换为新部门标准配置
- 记录调岗信息到审计日志

### 6. 临时借用
**场景：** 员工需要临时借用设备（如参加展会需要投影仪）。

**处理策略：**
- 分配时标记"临时借用"，设置预期归还日期
- 到期前自动提醒归还
- 超期未还自动升级提醒（发送给经理和 IT 部门）

---

## 典型业务场景

### 场景 1：新员工入职
```
1. HR 通知 IT 部门：张三入职，部门：研发部，入职日期：2024-12-01
2. IT 管理员准备设备：
   - 查询"库存中"的笔记本电脑（筛选：高性能配置）
   - 查询"库存中"的显示器（数量：2）
   - 查询"库存中"的键盘鼠标套装
3. 执行批量分配操作
4. 系统记录分配信息，生成领用单
5. 发送邮件给张三：设备清单、使用注意事项、归还流程
```

### 场景 2：设备故障报修
```
1. 员工李四发现笔记本无法开机
2. 提交报修申请：故障描述、紧急程度
3. IT 管理员接单：
   - 将资产状态从"已分配"改为"维修中"
   - 创建维修单，分配给维修人员
   - 如需替代设备，从库存分配临时设备给李四
4. 维修完成后：
   - 维修人员更新维修单状态
   - IT 管理员质检通过
   - 归还给李四（状态：已分配），或回库（状态：库存中）
5. 如临时设备已分配，提醒李四归还
```

### 场景 3：员工离职
```
1. HR 发起离职流程
2. 系统自动检查：李四当前持有 1 台笔记本 + 2 台显示器
3. 发送归还提醒给李四和其经理
4. 李四到 IT 部门归还设备
5. IT 管理员验收：
   - 检查外观、功能
   - 清除个人数据
   - 更新资产状态为"库存中"
6. 系统解除离职阻止
7. HR 完成离职手续
```

---

## 领域术语表

- **序列号（Serial Number）**：设备制造商提供的唯一硬件标识
- **资产标签（Asset Tag）**：组织内部编号，便于快速识别
- **领用 / 分配**：员工从 IT 部门获取资产使用权的过程
- **归还**：员工将资产交还给 IT 部门的过程
- **报修**：报告资产故障，申请维修
- **报废**：资产达到生命周期终点，不再使用
- **审计日志**：记录所有操作的历史，用于追溯和合规
- **乐观锁**：并发控制策略，假设冲突少，通过版本号检测冲突
- **终态**：状态机的最终状态，不可再转换（如"已报废"）

---

**文档目标：** 让 AI 在 `/speckit.specify` 阶段充分理解资产管理的业务本质，生成完整、准确、符合实际的需求规范（spec.md）。一旦 spec.md 生成，后续 plan/task/implement 阶段应直接依赖 spec.md，无需回溯此文档。

**字数统计：约 2000 字**