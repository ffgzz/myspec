<!-- 同步影响报告 -->
<!--
版本变更记录：新建文档
核心原则（新增）：
  - I. 领域驱动设计 (DDD)
  - II. 六边形架构 (Hexagonal Architecture)
  - III. 强一致性账务处理
  - IV. 多租户数据隔离
  - V. 反贫血领域模型
  - VI. 不可篡改审计日志
  - VII. 100% 测试覆盖率门禁
新增通用章节：无
-->

# Project Constitution (项目宪法)

## 项目愿景 (Project Vision)

**Nebula-Core** - 企业级供应链金融核心系统

**核心使命**：实现资金流与物流信息的全链路可信追溯，确保每一笔融资都有真实的贸易背景。

通过构建安全、可信、高效的金融基础设施，为供应链生态中的各方提供透明、可靠的资金流转服务。


## Core Principles（核心原则）

### I. 领域驱动设计 (DDD)

所有核心业务逻辑必须严格遵循领域驱动设计原则：

- **领域层纯净性**：Domain Layer 严禁依赖任何 Infrastructure 代码，包括但不限于数据库访问、网络请求、消息队列等。
- **有界上下文 (Bounded Context)**：明确划分业务边界，每个领域模型必须在其有界上下文中保持一致性。
- **聚合根 (Aggregate Root)**：通过聚合根维护领域对象的 invariants，任何外部访问必须通过聚合根进行。

**理由**：金融业务逻辑复杂且合规要求严格，领域模型必须独立于技术实现，确保业务规则的一致性和可维护性。

### II. 六边形架构 (Hexagonal Architecture)

系统必须采用六边形架构，通过 Port/Adapter 模式实现内外解耦：

- **端口驱动设计**：所有外部交互（数据库、API、消息队列等）必须通过明确定义的 Port 接口进行。
- **适配器隔离实现**：Infrastructure 代码封装为 Adapter，实现 Port 接口，对内隐藏外部依赖的复杂性。
- **依赖反转**：内层（Domain/Application）不依赖外层（Infrastructure），外层依赖内层定义的接口。

**理由**：金融系统需要灵活应对监管要求变化和技术栈演进，架构解耦是系统可维护性的基础保障。

### III. 强一致性账务处理

资金划转与核心账务处理必须满足 ACID 特性，严禁使用最终一致性模型：

- **原子性 (Atomicity)**：单笔资金划转必须整体成功或整体回滚，禁止部分成功状态。
- **一致性 (Consistency)**：账务处理后必须保持借贷平衡，余额状态必须实时一致。
- **隔离性 (Isolation)**：并发交易必须通过合适的隔离级别防止脏读、不可重复读和幻读。
- **持久性 (Durability)**：交易结果必须持久化存储，确保系统故障后可恢复。

**硬性禁令**：禁止使用 Saga 模式、Event Sourcing 最终一致性方案处理资金划转场景。

**理由**：资金交易涉及真实资产流转，任何数据不一致都可能导致资损和法律纠纷，强一致性是金融系统的底线要求。

### IV. 多租户数据隔离

系统设计必须原生支持 SaaS 级多租户数据隔离：

- **租户上下文贯穿**：所有领域操作必须在明确的租户上下文中执行，禁止跨租户数据访问。
- **数据隔离策略**：支持 Tenant ID 作为数据分片键，确保租户间数据物理或逻辑隔离。
- **租户感知查询**：所有数据查询必须隐式包含租户过滤条件，防止数据泄露风险。

**理由**：供应链金融平台服务多个企业客户，数据隔离是合规性要求和客户信任的基础。

### V. 反贫血领域模型

严禁编写只有 Getter/Setter 的贫血实体，业务行为必须封装在领域对象中：

- **富领域模型**：领域实体必须包含业务数据和业务行为，行为与数据不可分割。
- **自包含业务规则**：业务规则校验、状态转换逻辑必须内聚在领域对象内部。
- **禁止数据容器**：领域对象不是数据传输容器，其 public 方法必须反映业务意图。

**判定标准**：如果一个领域对象删除所有 getter 后无法独立完成任何业务操作，则该对象为贫血模型，必须重构。

**理由**：贫血模型导致业务规则分散在服务层，难以保证一致性和维护，反贫血模型确保业务行为内聚且可追溯。

### VI. 不可篡改审计日志

所有的状态变更（State Change）必须产生不可篡改的审计日志：

- **变更可追溯**：每一次业务状态变更必须记录操作者、操作时间、操作类型、变更前后状态。
- **防篡改机制**：审计日志一旦写入禁止修改和删除，支持追加但不允许变更历史记录。
- **完整事件链**：业务事件的因果关系必须通过 ID 关联，形成完整的事件溯源链。

**理由**：审计日志是合规性要求的基础，也是争议处理、责任认定和监管检查的唯一可信依据。

### VII. 100% 测试覆盖率门禁

核心领域层必须满足严格的测试覆盖率要求：

- **分支覆盖率 100%**：Domain Layer 所有分支路径必须有对应的单元测试覆盖。
- **测试不可绕过**：CI/CD 流水线必须配置测试覆盖率门禁，覆盖率不达标则阻断合并。
- **测试质量优先**：覆盖率是底线而非目标，测试必须验证正确的业务行为而非单纯凑数。

**理由**：金融系统对正确性要求极高，100% 测试覆盖率是质量内建的门禁，确保核心业务逻辑经过充分验证。


## 核心开发工作流 (Contract-First SDD)

本项目严格执行 **Knowledge-Augmented SDD** 流程。为确保代码质量与可维护性，任何功能开发必须经历以下五个阶段：

1. **Define (定义)**:
   * 产出: `01-spec.md`
   * 要求: 必须包含 **User Journey Map (用户旅程图)**，明确交互流程。
2. **Plan (计划)**:
   * 产出: `02-plan.md`
   * 要求: 重点分析 **数据流向 (Data Flow)** 和 **状态机 (State Machine)**。
3. **Blueprint (蓝图)**: **[关键核心]**
   * 产出: `03-blueprint.md`
   * 内容: **纯接口定义 (Interfaces)、类型声明 (Types) 和 测试桩 (Test Stubs)**。
   * **禁令**: 在此阶段严禁编写任何业务实现逻辑。
4. **Tasks (拆解)**:
   * 产出: `04-tasks.md`
   * 策略: 按 "骨架(Skeleton) -> 逻辑(Logic) -> 验证(Verify)" 进行分组。
5. **Build (实施)**:
   * 产出: 源代码
   * 要求: 严格填空，必须通过 Blueprint 中定义的所有测试。


## AI 协作公约 (Agent Protocols)

本公约约束 AI 智能体在本项目的行为模式。

### 1. 宪法至上 (Constitution First)
* 在执行任何操作（Coding, Planning, Refactoring）前，**必须隐式检查** `context/constitution.md`。
* 任何生成的代码或计划如果与宪法条款冲突，必须在输出前自我修正。

### 2. 严禁臆造 (No Hallucinations)
* **事实核查**: 禁止引用不存在的文件路径或错误的函数签名。

### 3. 代码完整性 (Code Integrity)
* **禁止省略**: 在实施阶段，严禁输出 `// ... rest of code`、`// implementation here` 或 `pass`（除非是接口定义）。交付的代码必须是完整的、可编译/可运行的。
* **原子化修改**: 编辑文件时，必须确保不破坏文件中原有的、与当前任务无关的逻辑。

### 4. 安全底线 (Security Baseline)
* **禁止硬编码**: 严禁在代码中直接写入 API Key、数据库密码或私钥。必须通过环境变量或配置文件注入。
* **输入防御**: 假设所有外部输入（API 参数、用户表单）都是恶意的，必须在系统边界进行严格验证。

### 5. 可读性与文档 (Readability)
* **Docstrings**: 所有公共接口（Public Interface）必须包含清晰的文档字符串，说明参数、返回值和潜在异常。
* **意图注释**: 复杂逻辑的注释应解释"为什么这么做"（Why），而不是"在做什么"（What）。

### 6. 测试驱动 (Test Adherence)
* **测试神圣**: 严禁修改测试代码来适应错误的实现逻辑（除非确认测试本身有误）。
* **验证闭环**: 提交代码前，必须确保其能够通过 Blueprint 阶段定义的所有测试桩。

### 7. 破坏性操作预警 (Destructive Action Warning)
* 在执行不可逆操作（如删除文件、重构核心架构、大规模升级依赖）前，必须在对话中明确列出风险并征求用户同意。


**版本号**: 1.0.0 | **生效日期**: 2026-01-06 | **最后修订日期**: 2026-01-06
